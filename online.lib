# $HOME/$twm_dir/online.lib
# Copyright (c) 2019-2024 Ueliton Alves Dos Santos
# Licensed under the Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License

# Estatistica de servidor
online() {
 reset
 SRC=$(w3m -debug -dump_source -o accept_encoding=UTF-8 "${URL}/online" -o user_agent="$(sed -n "${random_agent}p" $TMP/userAgent.txt)")
 NPG=$(echo $SRC | sed 's/href=/\n/g' | grep 'online/all/' | head -n 6 | tail -n 1 | cut -d\' -f2 | cut -d\/ -f4)
 echo "$NPG Pages"

# search
 echo "$(G_T "Searching")..."
 DATE1=$(date +%H:%M:%S)
 >k

 for num in `seq $NPG -1 6` ; do
  w3m -dump "${URL}/online/all/${num}" -o user_agent="$(sed -n "${random_agent}p" $TMP/userAgent.txt)"|head -n 18|tail -n 16 >>k
  grep '<< < 1 ' k && >k
 done

 w3m -dump "${URL}/online/all/5" -o user_agent="$(sed -n "${random_agent}p" $TMP/userAgent.txt)"|head -n 18|tail -n 16 >> k
 grep ' 4 5 ' k || >k
 w3m -dump "${URL}/online/all/4" -o user_agent="$(sed -n "${random_agent}p" $TMP/userAgent.txt)"|head -n 18|tail -n 16 >> k
 grep ' 3 4 ' k || >k
 w3m -dump "${URL}/online/all/3" -o user_agent="$(sed -n "${random_agent}p" $TMP/userAgent.txt)"|head -n 18|tail -n 16 >> k
 grep ' 2 3 ' k || >k
 w3m -dump "${URL}/online/all/2" -o user_agent="$(sed -n "${random_agent}p" $TMP/userAgent.txt)"|head -n 18|tail -n 16 >> k
 grep ' 1 2 ' k || >k
 w3m -dump "${URL}/online/all/1" -o user_agent="$(sed -n "${random_agent}p" $TMP/userAgent.txt)"|head -n 18|tail -n 16 >> k
 grep ' 1 ' k || >k
 grep '-' k >all.txt
 reset
 sed -i "/Overmobile/d" all.txt
 sed -i "/Onlinehp/d" all.txt
 sed -i "/,/d" all.txt
 sed -i "/\<</d" all.txt
 sed -i "/\ |/d" all.txt
 sed -i "/\[user/d" all.txt
 sed -i "/\[arrow/d" all.txt
 sed -i "/\ feed/d" all.txt
 sed -i "/\:/d" all.txt
 sed -i "/\!/d" all.txt
 sed -i "/\+/d" all.txt
 sort -u all.txt -o all.txt
 sed "s, ,~,g;s,',_,g" all.txt > w
# sed "s, ,~,g" all.txt|sed "s,',_,g" >w
 cat w >y ; sed -i "/_/d" y
 echo ""
 printf "\n$(G_T "Started") ${DATE1} - $(G_T "Finished") `date +%H:%M:%S` `date +%d\/%m\/%Y`\n"
 echo ""
 printf "$(G_T "Total pages online"): ${NPG}"
 printf "\n$(G_T "Total players"): `grep '~-~' w|wc -l`\n"
 STOPED=`grep "_~" w|wc -l`
 ACTIVE=`wc -l < y`
 printf "\n$(G_T "Active players"): ${ACTIVE} - $(G_T "Inactive players"): ${STOPED}\n"
 echo ""
 STOPED0=`grep "\[0]" w|grep "_~"|wc -l`
 ACTIVE0=`grep "\[0]" y|wc -l`
 printf "\n$(G_T "Active Asura"): ${ACTIVE0} - $(G_T "Inactive Asuras"): ${STOPED0}\n"
 STOPED1=`grep "\[1]" w|grep "_~"|wc -l`
 ACTIVE1=`grep "\[1]" y|wc -l`
 printf "\n$(G_T "Boreas active"): ${ACTIVE1} - $(G_T "Boreas inactive"): ${STOPED1}\n"
 echo ""
 printf "\n$(G_T "Warriors"): `grep ' Guerreiro' k|wc -l`\n"
 printf "\n$(G_T "In settings"): `grep ' Configura' k|wc -l`\n"
 printf "\n$(G_T "In the Forums"): `grep 'FÃ³rum' k|wc -l`\n"
 printf "\n$(G_T "In chats"): `grep '~Conversar' y|wc -l`\n"
 printf "\n$(G_T "In the mail"): `grep 'correio' w|wc -l`\n"
 rm k w y
 sleep 30s
}
