# $HOME/$twm_dir/coliseum.lib

# Copyright (c) 2019-2024 Ueliton Alves Dos Santos
# Licensed under the Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License

cl_access() {
 last_heal=$(( $(date +%s) - 90 ))
 last_dodge=$(( $(date +%s) - 20 ))
 last_atk=$(( $(date +%s) - "$LA" ))
 USH=$(grep -o -E '(hp)[^A-z0-9]{1,4}[0-9]{1,6}' $src_ram|grep -o -E '[0-9]{2,5}'|sed 's,\ ,,g')
 ENH=$(grep -o -E '(nbsp)[^A-Za-z0-9]{1,2}[0-9]{1,6}' $src_ram|sed -n 's,nbsp[;],,;s,\ ,,;1p')
 USER=$(grep -o -E '([[:upper:]][[:lower:]]{0,15}( [[:upper:]][[:lower:]]{0,13})?)[[:space:]][^[:alnum:]]s' $src_ram|sed -n 's,\ [<]s,,;s,\ ,_,;2p')
 ATK=$(grep -o -E '/coliseum/atk/[?]r[=][0-9]+' $src_ram|sed -n 1p)
 ATKRND=$(grep -o -E '/coliseum/atkrnd/[?]r[=][0-9]+' $src_ram)
 DODGE=$(grep -o -E '/coliseum/dodge/[?]r[=][0-9]+' $src_ram)
 HEAL=$(grep -o -E '/coliseum/heal/[?]r[=][0-9]+' $src_ram)
 RHP=$(awk -v ush="$USH" -v rper="$RPER" 'BEGIN { printf "%.0f", ush * rper / 100 + ush }')
 HLHP=$(awk -v ush=`< "$full_ram"` -v hper="$HPER" 'BEGIN { printf "%.0f", ush * hper / 100 }')

 if grep -q '?out_gate' $src_ram; then

   (
     w3m -cookie -o http_proxy=$PROXY -o accept_encoding=UTF-8 -debug -dump_source "${URL}/coliseum" -o user_agent="$vUserAgent" >$src_ram
   ) </dev/null &>/dev/null &
   time_exit 15

   printf "\n     ðŸ™‡â€ "
   w3m -dump -T text/html "$src_ram"|head -n 18|sed '0,/^\([a-z]\{2\}\)[[:space:]]\([0-9]\{2,5\}\)\([0-9]\{2\}\):\([0-9]\{2\}\)/s//\â™¥ï¸\2 â°\3:\4/;s,\[0\]\ ,\ðŸ”´,g;s,\[1\]\ ,\ðŸ”µ,g;s,\[stone\],\ ðŸ’ª,;s,\[herb\],\ ðŸŒ¿,;s,\[grass\],\ ðŸŒ¿,g;s,\[potio\],\ ðŸ’Š,;s,\ \[health\]\ ,\ ðŸ§¡,;s,\ \[icon\]\ ,\ ðŸ¾,g;s,\[rip\],\ ðŸ’€,g'
 elif grep -q '?end_fight' $src_ram; then

   (
     w3m -cookie -o http_proxy=$PROXY -o accept_encoding=UTF-8 -debug -dump_source "${URL}/coliseum" -o user_agent="$vUserAgent" >$src_ram
   ) </dev/null &>/dev/null &
   time_exit 15

   printf "\n     ðŸ™‡â€ "
   w3m -dump -T text/html "$src_ram"|head -n 18|sed '0,/^\([a-z]\{2\}\)[[:space:]]\([0-9]\{2,5\}\)\([0-9]\{2\}\):\([0-9]\{2\}\)/s//\â™¥ï¸\2 â°\3:\4/;s,\[0\]\ ,\ðŸ”´,g;s,\[1\]\ ,\ðŸ”µ,g;s,\[stone\],\ ðŸ’ª,;s,\[herb\],\ ðŸŒ¿,;s,\[grass\],\ ðŸŒ¿,g;s,\[potio\],\ ðŸ’Š,;s,\ \[health\]\ ,\ ðŸ§¡,;s,\ \[icon\]\ ,\ ðŸ¾,g;s,\[rip\],\ ðŸ’€,g'
   sleep 5s
 else
   BREAK_LOOP=1
   printf "${BLACK_YELLOW}$(G_T "Battle is over").${COLOR_RESET}\n" ; sleep 2s
 fi

}

coliseum_fight() {

 if [ -d "/dev/shm" ]; then
   local dir_ram="/dev/shm/"
 else
   local dir_ram="$PREFIX/tmp/"
 fi

 mkdir -p $dir_ram
 local src_ram=$(mktemp -p $dir_ram data.XXXXXX)
 local full_ram=$(mktemp -p $dir_ram data.XXXXXX)
 local tmp_ram=$(mktemp -d -t twmdir.XXXXXX)
 cp -r $TMP/* $tmp_ram
 cd $tmp_ram

 (
   w3m -cookie -o http_proxy=$PROXY -o accept_encoding=UTF-8 -debug -dump_source "$URL/train" -o user_agent="$vUserAgent"|grep -o -E '\(([0-9]+)\)'|sed 's/[()]//g' >$full_ram
 ) </dev/null &>/dev/null &
 time_exit 15

 #/enterFight
 local LA=5
 local HPER=38
 local RPER=5
 printf "\n$(G_T "Coliseum") ...\n"

 (
   w3m -cookie -o http_proxy=$PROXY -o accept_encoding=UTF-8 -debug $URL/settings/graphics/0 -o user_agent="$vUserAgent" >$src_ram
 ) </dev/null &>/dev/null &
 time_exit 15

 printf "/settings/graphics/0\n"

 (
   w3m -cookie -o http_proxy=$PROXY -o accept_encoding=UTF-8 -debug -dump_source "$URL/coliseum" -o user_agent="$vUserAgent" >$src_ram
 ) </dev/null &>/dev/null &
 time_exit 15

 if grep -q -o '?end_fight' $src_ram; then

   (
     w3m -cookie -o http_proxy=$PROXY -o accept_encoding=UTF-8 -debug "$URL/coliseum/?end_fight=true" -o user_agent="$vUserAgent"|head -n 11|tail -n 7|sed "/\[2hit/d;/\[str/d;/combat/d"
   ) </dev/null &>/dev/null &
   time_exit 15

   printf "/coliseum/?end_fight=true\n"

   (
     w3m -cookie -o http_proxy=$PROXY -o accept_encoding=UTF-8 -debug -dump_source "$URL/coliseum" -o user_agent="$vUserAgent" >$src_ram
   ) </dev/null &>/dev/null &
   time_exit 15

 fi

 local access_link=$(grep -o -E '/coliseum(/[A-Za-z]+/[?]r[=][0-9]+|/)' $src_ram|sed -n '1p')
 local go_stop=$(grep -o -E '/coliseum/enterFight/[?]r[=][0-9]+' $src_ram)

 if [ -n "$go_stop" ]; then
   printf " ðŸ‘£ $(G_T "Entering")...\n${go_stop}\n"

   (
     w3m -cookie -o http_proxy=$PROXY -o accept_encoding=UTF-8 -debug -dump_source "${URL}${go_stop}" -o user_agent="$vUserAgent" >$src_ram
   ) </dev/null &>/dev/null &
   time_exit 15

   local access_link=$(grep -o -E '/coliseum(/[A-Za-z]+/[?]r[=][0-9]+|/)' $src_ram|grep -v 'dodge'|sed -n 1p)
   #/wait
   printf " ðŸ˜´ $(G_T "Waiting")...\n"

   until grep -q 'coliseum/dodge/' $src_ram; do
     (
       w3m -cookie -o http_proxy=$PROXY -o accept_encoding=UTF-8 -debug -dump_source "${URL}$access_link" -o user_agent="$vUserAgent" >$src_ram
     ) </dev/null &>/dev/null &
     time_exit 15

     local access_link=$(grep -o -E '/(coliseum/[A-Za-z]+/[?]r[=][0-9]+|coliseum)' $src_ram|grep -v 'dodge'|sed -n 1p)
     printf " ðŸ’¤	...\n${access_link}\n"
     sleep 3s

   done

   cl_access
   local OLDHP="$USH"
   BREAK_LOOP=""

   until [ -n "$BREAK_LOOP" ]; do

     #/heal
     if [ -n "$USH" ] && [ -n "$HPLP" ] && [ -n "$last_heal" ] && \
     [ "$USH" -lt "$HLHP" ] > /dev/null 2>&1 && [ "$(( $(date +%s) - $last_heal ))" -gt 90 ] > /dev/null 2>&1 && [ "$(( $(date +%s) - $last_heal ))" -lt 300 ] > /dev/null 2>&1; then

       (
         w3m -cookie -o http_proxy=$PROXY -o accept_encoding=UTF-8 -debug -dump_source "${URL}$HEAL" -o user_agent="$vUserAgent" >$src_ram
       ) </dev/null &>/dev/null &
       time_exit 15

       cl_access
       echo "$USH" >$full_ram
#       OLDHP=$USH
       last_heal=$(date +%s)
       last_atk=$(date +%s)

     #/dodge
     elif [ -n "$USH" ] && [ -n "$OLDHP" ] && [ -n "$last_dodge" ] && \
     ! grep -q -o 'txt smpl grey' $src_ram && [ "$(( $(date +%s) - $last_dodge ))" -gt 20 ] > /dev/null 2>&1 && [ "$(( $(date +%s) - $last_dodge ))" -lt 300 ] > /dev/null 2>&1 && [ "$USH" -lt "$OLDHP" ] > /dev/null 2>&1; then

       (
         w3m -cookie -o http_proxy=$PROXY -o accept_encoding=UTF-8 -debug -dump_source "${URL}$DODGE" -o user_agent="$vUserAgent" >$src_ram
       ) </dev/null &>/dev/null &
       time_exit 15

       cl_access
       OLDHP="$USH"
       last_dodge=$(date +%s)
       last_atk=$(date +%s)

     #/random
     elif [ -n "$RHP" ] && [ -n "$ENH" ] && [ -n "$last_attack" ] && \
     awk -v latk="$(( $(date +%s) - $last_atk ))" -v atktime="$LA" 'BEGIN { exit !(latk != atktime) }' > /dev/null 2>&1 && ! grep -q -o 'txt smpl grey' $src_ram && [ "$RHP" -lt "$ENH" ] > /dev/null 2>&1 || awk -v latk="$(( $(date +%s) - $last_atk ))" -v atktime="$LA" 'BEGIN { exit !(latk != atktime) }' > /dev/null 2>&1 && ! grep -q -o 'txt smpl grey' $src_ram && grep -q -o "$USER" allies.txt; then

       (
         w3m -cookie -o http_proxy=$PROXY -o accept_encoding=UTF-8 -debug -dump_source "${URL}$ATKRND" -o user_agent="$vUserAgent" >$src_ram
       ) </dev/null &>/dev/null &
       time_exit 15

       cl_access
       last_atk=$(date +%s)

     #/attack
     elif awk -v latk="$(( $(date +%s) - $last_atk ))" -v atktime="$LA" 'BEGIN { exit !(latk > atktime) }' > /dev/null 2>&1; then

       (
         w3m -cookie -o http_proxy=$PROXY -o accept_encoding=UTF-8 -debug -dump_source "${URL}$ATK" -o user_agent="$vUserAgent" >$src_ram
       ) </dev/null &>/dev/null &
       time_exit 15

       cl_access
       last_atk=$(date +%s)
     else

       (
         w3m -cookie -o http_proxy=$PROXY -o accept_encoding=UTF-8 -debug -dump_source "${URL}/coliseum" -o user_agent="$vUserAgent" >$src_ram
       ) </dev/null &>/dev/null &
       time_exit 15

       cl_access
       sleep 1s
     fi

   done

   rm $src_ram $full_ram
   unset last_heal last_dodge last_atk USH ENH USER ATK ATKRND DODGE HEAL BREAK_LOOP cl_access
   #/end
   func_unset

   if [ "$RUN" != "acl" ]; then
     printf "\nYou can run ./twmu -cl\n"
   fi

   printf "${GREEN_BLACK}$(G_T "Coliseum") (âœ”)${COLOR_RESET}\n"
 else
   printf "${WHITEb_BLACK}$(G_T "It was not possible to start the battle at this moment").${COLOR_RESET}\n"
 fi

}

coliseum_start() {

 if $(case $(date +%H:%M) in
   (09:2[4-9]|9:5[4-9]|10:1[0-4]|10:2[4-9]|10:5[4-9]|12:2[4-9]|13:5[4-9]|14:5[4-9]|15:5[4-9]|16:1[0-4]|16:2[4-9]|18:5[4-9]|20:5[4-9]|21:2[4-9]|21:5[4-9]|22:2[4-9])
     exit 1 ;;
 esac); then

   if [ "$RUN" = "aboot" ]; then

     (
       w3m -cookie -o http_proxy=$PROXY -o accept_encoding=UTF-8 -debug -dump_source "${URL}/quest/" -o user_agent="$vUserAgent" >$TMP/SRC
     ) </dev/null &>/dev/null &
     time_exit 15

     while grep -q -E '/coliseum/[?]quest_t[=]quest&quest_id[=]11&qz[=][a-z0-9]+' $TMP/SRC; do
       coliseum_fight

       (
        w3m -cookie -o http_proxy=$PROXY -o accept_encoding=UTF-8 -debug -dump_source "${URL}/quest/" -o user_agent="$vUserAgent" >$TMP/SRC
       ) </dev/null &>/dev/null &
       time_exit 15

       local ENDQUEST=$(grep -o -E '/quest/end/11[?]r[=][A_z0-9]+' $TMP/SRC)

       if [ ! -z "$ENDQUEST" ]; then

        (
          w3m -cookie -o http_proxy=$PROXY -o accept_encoding=UTF-8 -debug -dump_source "${URL}${ENDQUEST}" -o user_agent="$vUserAgent" >$TMP/SRC
        ) </dev/null &>/dev/null &
        time_exit 15
       fi

     done

   elif [ "$RUN" = "acl" ]; then
     coliseum_fight
   fi

 else
   printf "$(G_T "Battle or event time")...\n" && sleep 5s
 fi

}
